name: Reusable Deploy

on:
  workflow_call:
    inputs:
      image_name: { required: true, type: string }
      deployment_name: { required: true, type: string }
      directory: { required: true, type: string }
      kustomize_patch_name: { required: true, type: string }

# This prevents race conditions in your Namespace
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  build-publish-deploy:
    runs-on: ubuntu-latest
    environment: dev
    env:
      GKE_CLUSTER: dwk-cluster
      GKE_ZONE: europe-north1-b
      REGISTRY: europe-north1-docker.pkg.dev
      REPOSITORY: my-repository
      PROJECT_ID: ${{ secrets.GKE_PROJECT }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # ... (Auth, Gcloud, GKE, Docker steps same as before) ...

      - name: Build and Publish
        run: |-
          TAG="$REGISTRY/$PROJECT_ID/$REPOSITORY/${{ inputs.image_name }}:${{ github.ref_name }}-$GITHUB_SHA"
          docker build -t $TAG ./${{ inputs.directory }}
          docker push $TAG
          echo "TAG=$TAG" >> $GITHUB_ENV

      - name: Set up Kustomize
        uses: imranismail/setup-kustomize@v2.1.0

      - name: Deploy
        run: |-
          # Extract Namespace
          if [ "${{ github.event_name }}" = "pull_request" ] || [ "${{ github.event_name }}" = "pull_request_target" ]; then
            NAMESPACE="${{ github.event.pull_request.head.ref }}"
          elif [ "${{ github.ref_name }}" = "main" ]; then
            NAMESPACE="project"
          else
            NAMESPACE="${{ github.ref_name }}"
          fi

          # Sanitize namespace (k8s doesn't like slashes or dots)
          NAMESPACE=$(echo $NAMESPACE | sed 's/[^a-zA-Z0-9-]/-/g' | tr '[:upper:]' '[:lower:]')

          kubectl get namespace $NAMESPACE > /dev/null 2>&1 || kubectl create namespace $NAMESPACE
          kubectl config set-context --current --namespace=$NAMESPACE

          cd ${{ inputs.directory }}
          kustomize edit set image ${{ inputs.kustomize_patch_name }}=$TAG
          kustomize edit set namespace $NAMESPACE

          kustomize build . | kubectl apply -f -
          kubectl rollout status deployment/${{ inputs.deployment_name }}
